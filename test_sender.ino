#include <SoftwareSerial.h>

#define FV(s) ((const __FlashStringHelper*)(s))
// 플래시 영역의 문자열을 출력하기 위한 F매크로

//blink 예제의 hex파일. 2497바이트. \0 포함면 2498.
const char msg[] PROGMEM = ":100000000C945C000C946E000C946E000C946E00CA:100010000C946E000C946E000C946E000C946E00A8:100020000C946E000C946E000C946E000C946E0098:100030000C946E000C946E000C946E000C946E0088:100040000C9413010C946E000C946E000C946E00D2:100050000C946E000C946E000C946E000C946E0068:100060000C946E000C946E00000000002400270029:100070002A0000000000250028002B0004040404CE:100080000404040402020202020203030303030342:10009000010204081020408001020408102001021F:1000A00004081020000000080002010000030407FB:1000B000000000000000000011241FBECFEFD8E0B8:1000C000DEBFCDBF21E0A0E0B1E001C01D92A930AC:1000D000B207E1F70E945D010C94CC010C94000082:1000E000E1EBF0E02491EDE9F0E09491E9E8F0E053:1000F000E491EE23C9F0222339F0233001F1A8F472:10010000213019F1223029F1F0E0EE0FFF1FEE58F7:10011000FF4FA591B4912FB7F894EC91811126C0AF:1001200090959E239C932FBF08952730A9F02830E7:10013000C9F0243049F7209180002F7D03C0209121:1001400080002F7720938000DFCF24B52F7724BD48:10015000DBCF24B52F7DFBCF2091B0002F772093EC:10016000B000D2CF2091B0002F7DF9CF9E2BDACFF7:100170003FB7F8948091050190910601A091070185:10018000B091080126B5A89B05C02F3F19F0019634:10019000A11DB11D3FBFBA2FA92F982F8827BC01E1:1001A000CD01620F711D811D911D42E0660F771F09:1001B000881F991F4A95D1F708958F929F92AF9209:1001C000BF92CF92DF92EF92FF920E94B8004B0154:1001D0005C0188EEC82E83E0D82EE12CF12C0E9421:1001E000B800681979098A099B09683E734081053E:1001F0009105A8F321E0C21AD108E108F10888EEC0:10020000880E83E0981EA11CB11CC114D104E10426:10021000F10429F7FF90EF90DF90CF90BF90AF905F:100220009F908F9008951F920F920FB60F921124F6:100230002F933F938F939F93AF93BF93809101012F:1002400090910201A0910301B0910401309100014D:1002500023E0230F2D3758F50196A11DB11D2093E2:1002600000018093010190930201A0930301B093D8:1002700004018091050190910601A0910701B091C0:1002800008010196A11DB11D8093050190930601FF:10029000A0930701B0930801BF91AF919F918F91F7:1002A0003F912F910F900FBE0F901F90189526E849:1002B000230F0296A11DB11DD2CF789484B5826020:1002C00084BD84B5816084BD85B5826085BD85B5FA:1002D000816085BD80916E00816080936E00109278:1002E00081008091810082608093810080918100F3:1002F0008160809381008091800081608093800084:100300008091B10084608093B1008091B0008160E1:100310008093B00080917A00846080937A0080910D:100320007A00826080937A0080917A008160809365:100330007A0080917A00806880937A001092C100E0:10034000EDE9F0E02491E9E8F0E08491882399F068:1003500090E0880F991FFC01E859FF4FA591B491D7:10036000FC01EE58FF4F859194918FB7F894EC9172:10037000E22BEC938FBFC0E0D0E081E00E947000E0:100380000E94DD0080E00E9470000E94DD00209746:0C039000A1F30E940000F1CFF894FFCF11:00000001FF";
//플래시에 저장되어 있어서 전체 길이를 끌고오면 주소 길이가 찍힘...
//strcpy등으로 나눠서 갖고오면서 전체 길이를 추려봐야 할 듯

int start_time = 0;

int split_num = 0; //몇 개로 쪼개는가?

void setup() {
  //  SoftwareSerial xbee(2, 3); //2,3번 핀을 통해 소프트웨어 시리얼 연결.
  //  xbee.begin(9600);

  Serial.begin(9600); //개발 테스트용. 사용시 소프트웨어 시리얼 비활성화할 것.
  int msg_length = sizeof(msg); //2498 바이트, \0이 포함된 길이임.
  
  Serial.println("b"); //비콘 전송
  
  String tmp_str = "";
  int rssi = 0;

  while (!Serial.available()) { //응답이 있는 경우
    tmp_str = Serial.readStringUntil('\n');

    rssi = tmp_str.toInt();
    
    if (rssi > 50) { // threshold 기준치 설정. 임의로 50으로 잡음
      split_num = 10; // 10바이트로 쪼갬.
      break;
      }
    else if (0 < rssi && rssi <= 50){
      split_num = 100; // 100바이트로 쪼갬.
      break;
      }
  }

  Serial.println(rssi);

  Serial.println("bicon end");

  char str[15];

  strncpy_P(str, msg, 10);

  Serial.println(sizeof(str));

  Serial.println(str);

  Serial.println(FV(msg));

  start_time = millis(); //시작 시간

}

void loop() {
  int end_time = millis(); //종료 시간
  int total_time = start_time - end_time; //코드 가동 시간

  // FV(message)로 PROGMEM 접근 가능

  //  Serial.print(FV(msg));

  exit(0);
}
